<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Capacitor Invader</title>
<style>
  body {
    margin: 0;
    background: linear-gradient(180deg, #001b12, #000);
    color: #9affc9;
    font-family: Consolas, monospace;
    text-align: center;
  }
  canvas {
    background:
      linear-gradient(#0a2 1px, transparent 1px),
      linear-gradient(90deg, #0a2 1px, transparent 1px),
      radial-gradient(circle at top, #033, #000);
    background-size: 40px 40px, 40px 40px, cover;
    display: block;
    margin: 20px auto;
    border-radius: 12px;
    box-shadow: 0 0 20px #0f8;
  }
</style>
</head>
<body>

<h1>üè∞‚ö° Capacitor Invader ‚ö°</h1>
<p>‚Üê ‚Üí ÁßªÂãï / Space Áô∫Â∞Ñ</p>
<canvas id="game" width="520" height="640"></canvas>
<p id="score">Score: 0</p>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== „Çµ„Ç¶„É≥„Éâ =====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, time=0.12) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + time);
  osc.stop(audioCtx.currentTime + time);
}

// ===== Áä∂ÊÖã =====
let gameState = "play"; // play | over | clear
let player, bullets, enemyBullets, enemies;
let enemyDir, score;

// ===== ÂàùÊúüÂåñ =====
function initGame() {
  gameState = "play";
  player = { x: 240, y: 570, w: 40, h: 30, speed: 6, alive: true };
  bullets = [];
  enemyBullets = [];
  enemies = [];
  enemyDir = 1;
  score = 0;
  document.getElementById("score").textContent = "Score: 0";

  for (let r = 0; r < 4; r++) {
    for (let c = 0; c < 7; c++) {
      enemies.push({
        x: 80 + c * 60,
        y: 80 + r * 55,
        w: 26,
        h: 36,
        alive: true
      });
    }
  }
}

initGame();

// ===== ÂÖ•Âäõ =====
const keys = {};
document.addEventListener("keydown", e => {
  keys[e.code] = true;

  if ((gameState === "over" || gameState === "clear") && e.code === "Enter") {
    initGame();
  }
});
document.addEventListener("keyup", e => keys[e.code] = false);

// ===== ÊèèÁîª =====
function drawCastle(p) {
  if (!p.alive) return;
  ctx.fillStyle = "#888";
  ctx.fillRect(p.x, p.y, p.w, p.h);
  ctx.fillStyle = "#aaa";
  ctx.fillRect(p.x + 4, p.y - 10, 8, 10);
  ctx.fillRect(p.x + p.w - 12, p.y - 10, 8, 10);
  ctx.fillStyle = "#666";
  ctx.fillRect(p.x + 16, p.y - 14, 8, 14);
}

function drawCapacitor(e) {
  const cx = e.x + e.w / 2;
  const bottom = e.y + e.h;
  ctx.strokeStyle = "#ccc";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx - 4, bottom);
  ctx.lineTo(cx - 6, bottom + 12);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx + 4, bottom);
  ctx.lineTo(cx + 6, bottom + 12);
  ctx.stroke();
  ctx.fillStyle = "#b00000";
  ctx.beginPath();
  ctx.ellipse(cx, e.y + e.h / 2, e.w / 2, e.h / 2, 0, 0, Math.PI * 2);
  ctx.fill();
}

function drawEnemyBolt(b) {
  ctx.strokeStyle = "#fff200";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(b.x, b.y);
  ctx.lineTo(b.x - 4, b.y + 6);
  ctx.lineTo(b.x + 3, b.y + 12);
  ctx.lineTo(b.x - 2, b.y + 18);
  ctx.stroke();
}

// ===== Êõ¥Êñ∞ =====
function update() {
  if (gameState !== "play") return;

  if (keys["ArrowLeft"]) player.x -= player.speed;
  if (keys["ArrowRight"]) player.x += player.speed;
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

  if (keys["Space"] && bullets.length < 6) {
    bullets.push({ x: player.x + 18, y: player.y });
    beep(800);
    keys["Space"] = false;
  }

  bullets.forEach(b => b.y -= 9);
  bullets = bullets.filter(b => b.y > 0);

  let edge = false;
  enemies.forEach(e => {
    if (!e.alive) return;
    e.x += enemyDir * 1.2;
    if (e.x < 20 || e.x + e.w > canvas.width - 20) edge = true;

    if (
      e.y + e.h >= player.y &&
      e.x < player.x + player.w &&
      e.x + e.w > player.x
    ) {
      gameState = "over";
      player.alive = false;
      beep(90, 0.6);
    }

    if (Math.random() < 0.002) {
      enemyBullets.push({ x: e.x + e.w / 2, y: e.y + e.h });
    }
  });

  if (edge) {
    enemyDir *= -1;
    enemies.forEach(e => e.y += 10);
  }

  enemyBullets.forEach(b => {
    b.y += 5;
    if (
      b.x > player.x &&
      b.x < player.x + player.w &&
      b.y > player.y &&
      b.y < player.y + player.h
    ) {
      gameState = "over";
      player.alive = false;
      beep(90, 0.6);
    }
  });

  bullets.forEach(b => {
    enemies.forEach(e => {
      if (
        e.alive &&
        b.x < e.x + e.w &&
        b.x + 4 > e.x &&
        b.y < e.y + e.h &&
        b.y + 10 > e.y
      ) {
        e.alive = false;
        b.y = -100;
        score += 150;
        document.getElementById("score").textContent = "Score: " + score;
        beep(220, 0.2);
      }
    });
  });

  if (enemies.every(e => !e.alive)) {
    gameState = "clear";
    beep(1200, 0.6);
  }
}

// ===== ÊèèÁîª =====
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawCastle(player);
  ctx.fillStyle = "#9ff";
  bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 12));
  enemyBullets.forEach(drawEnemyBolt);
  enemies.forEach(e => e.alive && drawCapacitor(e));

  if (gameState === "over") {
    ctx.fillStyle = "#ff6666";
    ctx.font = "48px Consolas";
    ctx.fillText("SHIZUKI OVER", 90, 320);
    ctx.font = "18px Consolas";
    ctx.fillText("Press ENTER to Restart", 130, 360);
  }

  if (gameState === "clear") {
    ctx.fillStyle = "#66ff99";
    ctx.font = "48px Consolas";
    ctx.fillText("SHIZUKI HAPPY", 80, 320);
    ctx.font = "18px Consolas";
    ctx.fillText("Press ENTER to Restart", 130, 360);
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
